# Copyright (c) Microsoft Corporation.
# Licensed under the MIT License.

# Tasks:
#   OS: hosts file, Entries - /etc/hosts
#   Simplified version using Python filter for SAP-specific entries
#

---

# -------------------------------------+---------------------------------------8
#
# Description:  Validation for Prerequisites
#
- name:                                "2.4 Hosts: - import pre_checks"
  ansible.builtin.import_tasks:        pre_checks.yaml
# -------------------------------------+---------------------------------------8

#   OS: hosts file, Entries - /etc/hosts (Common entries)
- name:                                "2.4 Hosts: - OS: Common, Entries - /etc/hosts"
  ansible.builtin.blockinfile:
    path:                              /etc/hosts
    mode:                              0644
    create:                            true
    backup:                            true
    state:                             present
    block:                             "{{ lookup('file', 'hosts.block') }}"
    marker:                            "# {mark} ANSIBLE MANAGED BLOCK - COMMON"

# -------------------------------------+---------------------------------------8
#
# Description: Backwards compatibility - normalize variable names
#
- name:                                "2.4 Hosts: - Backward Compatibility - Check required Database HA variables"
  ansible.builtin.set_fact:
    database_high_availability:       "{{ db_high_availability | default(false) }}"
  when:
    - db_high_availability is defined
    - database_high_availability is not defined

- name:                                "2.4 Hosts: - Backward Compatibility - Database loadbalancer IP"
  ansible.builtin.set_fact:
    database_loadbalancer_ip:          "{{ db_lb_ip }}"
  when:
    - db_lb_ip is defined
    - database_loadbalancer_ip is not defined

# -------------------------------------+---------------------------------------8
#
# Description: Generate all SAP hosts entries using Python filter
# This replaces the complex Jinja template and multiple blockinfile tasks
#
- name:                                "2.4 Hosts: - Generate SAP hosts entries using Python filter"
  ansible.builtin.set_fact:
    sap_hosts_content:                 "{{ vars | sdaf_generate_sap_hosts }}"

- name:                                "2.4 Hosts: - Update /etc/hosts with all SAP entries"
  ansible.builtin.copy:
    dest:                              /etc/hosts
    content:                           "{{ existing_hosts_content + sap_hosts_content | join('\n') + '\n' }}"
    mode:                              0644
    backup:                            true
  vars:
    # Read existing hosts content and preserve non-SAP entries
    existing_hosts_file:               "{{ lookup('file', '/etc/hosts', errors='ignore') }}"
    existing_hosts_lines:              "{{ existing_hosts_file.split('\n') if existing_hosts_file else [] }}"
    # Remove any existing SAP managed blocks to avoid duplicates
    filtered_hosts_lines: >-
      {{
        existing_hosts_lines |
        select('match', '^(?!# BEGIN ANSIBLE MANAGED BLOCK - ' + sap_sid | upper + ').*') |
        select('match', '^(?!# END ANSIBLE MANAGED BLOCK - ' + sap_sid | upper + ').*') |
        select('match', '^(?!# BEGIN ASCS/ERS Entries).*') |
        select('match', '^(?!# END ASCS/ERS Entries).*') |
        select('match', '^(?!# BEGIN DB Entries).*') |
        select('match', '^(?!# END DB Entries).*') |
        list
      }}
    existing_hosts_content: >-
      {{
        (filtered_hosts_lines | reject('regex', '^$') | list) +
        ([''] if filtered_hosts_lines | length > 0 else [])
      }}

# -------------------------------------+---------------------------------------8
#
# Description: iSCSI setup (hostname resolution)
#
- name:                                "2.4 Hosts: - Setup iSCSI host name resolution"
  ansible.builtin.lineinfile:
    path:                              /etc/hosts
    line: >-
      {{ '%-19s' | format(iscsi_server.ip) }} {{ '%-80s' | format(iscsi_server.host + '.' + sap_fqdn) }} {{ '%-21s' | format(iscsi_server.host) }}
    backup:                            true
  loop:                                "{{ iscsi_servers }}"
  loop_control:
    loop_var:                          iscsi_server
  when:                                iscsi_servers is defined

# -------------------------------------+---------------------------------------8
#
# Description: Optional validation and cleanup
#
- name:                                "2.4 Hosts: - Validate generated hosts file"
  ansible.builtin.command:
    cmd:                               "getent hosts {{ item }}"
  loop:
    - "{{ sap_sid | lower }}scs{{ scs_instance_number }}cl1.{{ sap_fqdn }}"
    - "{{ sap_sid | lower }}ers{{ ers_instance_number }}cl2.{{ sap_fqdn }}"
  register:                            hosts_validation
  failed_when:                         false
  changed_when:                        false
  when:
    - scs_high_availability | default(false)

- name:                                "2.4 Hosts: - Display validation results"
  ansible.builtin.debug:
    msg:
      - "Host resolution validation:"
      - "{{ item.item }}: {{ 'SUCCESS' if item.rc == 0 else 'FAILED' }}"
  loop:                                "{{ hosts_validation.results | default([]) }}"
  when:
    - hosts_validation is defined
    - hosts_validation.results is defined

...
